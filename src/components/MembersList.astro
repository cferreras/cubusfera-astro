---
import StatusMessage from './ui/StatusMessage.astro';
import Card from './ui/Card.astro';
import { User, Shield, Crown, Hammer } from 'lucide-react';

// Obtener la URL de la API desde las variables de entorno
const WHITELIST_API_URL = (import.meta.env as ImportMetaEnv & {
  WHITELIST_API_URL?: string
}).WHITELIST_API_URL || 'http://localhost:8080/whitelist';

interface Member {
  name: string;
  online: boolean;
  group: string;
}

let members: Member[] = [];
let error = null;
let isServerOffline = false;

try {
  const whitelistResponse = await fetch(WHITELIST_API_URL, {
    headers: {
      'Cache-Control': 'no-cache, no-store, must-revalidate',
      'Pragma': 'no-cache',
      'Expires': '0'
    }
  });
  if (whitelistResponse.ok) {
    members = await whitelistResponse.json();
  } else if (whitelistResponse.status === 502 || whitelistResponse.status === 503 || whitelistResponse.status === 504) {
    isServerOffline = true;
    error = 'El servidor de Minecraft está temporalmente desconectado. Intenta de nuevo más tarde.';
  } else {
    error = 'Error al obtener la lista de miembros.';
  }
} catch (e) {
  if (e instanceof TypeError && (e as TypeError).message.includes('fetch')) {
    isServerOffline = true;
    error = 'El servidor de Minecraft está temporalmente desconectado. Intenta de nuevo más tarde.';
  } else {
    error = 'Error de conexión.';
  }
}

function getGroupIcon(group: string) {
  switch (group.toLowerCase()) {
    case 'owner': return Crown;
    case 'admin': return Shield;
    case 'mod': return Hammer;
    default: return User;
  }
}

function getGroupColor(group: string): string {
  switch (group.toLowerCase()) {
    case 'owner': return 'text-red-600 bg-red-500/10 border-red-500/20';
    case 'admin': return 'text-orange-600 bg-orange-500/10 border-orange-500/20';
    case 'mod': return 'text-blue-600 bg-blue-500/10 border-blue-500/20';
    default: return 'text-brand-green bg-brand-green/10 border-brand-green/20';
  }
}
---

{error ? (
  <StatusMessage
    type={isServerOffline ? 'offline' : 'error'}
    message={error}
    title={isServerOffline ? undefined : 'Error al cargar miembros'}
  />
) : (
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
    {members.map((member) => {
      const Icon = getGroupIcon(member.group);
      const groupColorClass = getGroupColor(member.group);
      
      return (
        <Card class="group hover:border-brand-green/30 transition-all duration-300">
          <a href={`/miembros/${member.name}`} class="flex items-center gap-4">
            <div class="relative shrink-0">
              <img
                src={`https://mc-heads.net/avatar/${member.name}/48`}
                alt={member.name}
                class="w-12 h-12 rounded-lg shadow-sm group-hover:scale-105 transition-transform duration-300"
                loading="lazy"
              />
              <div class={`absolute -bottom-1 -right-1 w-3 h-3 rounded-full border-2 border-card ${member.online ? 'bg-green-500' : 'bg-gray-500'}`}></div>
            </div>
            
            <div class="flex-1 min-w-0">
              <h3 class="text-base font-semibold text-foreground truncate group-hover:text-brand-green transition-colors">
                {member.name}
              </h3>
              <div class={`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium border mt-1 ${groupColorClass}`}>
                <Icon className="w-3 h-3" />
                <span class="capitalize">{member.group}</span>
              </div>
            </div>
          </a>
        </Card>
      );
    })}
  </div>
)}
