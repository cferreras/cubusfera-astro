---
export const prerender = false;
import Layout from "../../layouts/main.astro";
import PlayerStats from "../../components/PlayerStats.astro";
import PlayerProfile from "../../components/PlayerProfile.astro";
import Breadcrumb from "../../components/Breadcrumb.astro";
import { User } from "lucide-react";

// Obtener el par�metro del miembro desde la URL
const { member } = Astro.params;

// Validar que el par�metro existe
if (!member) {
    return Astro.redirect("/miembros");
}

// Obtener estado online y grupo del jugador
const WHITELIST_API_URL = import.meta.env.WHITELIST_API_URL || "https://stats.cubusfera.com/whitelist";

let isOnline = false;
let playerGroup = "default";
try {
    const whitelistResponse = await fetch(WHITELIST_API_URL);
    if (whitelistResponse.ok) {
        const members = await whitelistResponse.json();
        if (Array.isArray(members)) {
            const memberData = members.find(
                (m: { name: string; online: boolean; group: string }) =>
                    m.name === member,
            );
            isOnline = memberData?.online || false;
            playerGroup = memberData?.group || "default";
        }
    }
} catch (e) {
    console.error("Error fetching online status:", e);
}

// Obtener datos del perfil para saber si tiene información personal
const PROFILE_API_URL = "https://stats.cubusfera.com/profile/";
let hasPersonalInfo = false;
try {
    const profileResponse = await fetch(PROFILE_API_URL);
    if (profileResponse.ok) {
        const profileData = await profileResponse.json();
        // Funci�n para validar si hay contenido social v�lido
        const hasSocialContent = (social: any) => {
            if (!social || typeof social !== "object") return false;
            const { discord, twitter, youtube, instagram } = social;
            return !!(discord || twitter || youtube || instagram);
        };

        hasPersonalInfo = !!(
            profileData.bio || hasSocialContent(profileData.social)
        );
    }
} catch (e) {
    // Ignorar errores de conexi�n
}
---

<Layout
    content={{
        title: `${member} - Perfil de Jugador`,
        description: `Estadísticas y perfil de ${member} en Cubusfera.`,
    }}
>
    <Breadcrumb
        items={[
            { label: "Inicio", href: "/" },
            { label: "Miembros", href: "/miembros" },
            { label: member },
        ]}
    />

    <div class="container mx-auto px-4 mt-8">
        <div class="flex flex-col md:flex-row gap-8 items-start">
            {/* Columna Izquierda: Avatar Sticky */}
            <div class="relative shrink-0 md:sticky md:top-24">
                <img
                    src={`https://minotar.net/armor/body/${member}/200.png`}
                    alt={`Skin de ${member}`}
                    class="h-64 w-auto drop-shadow-2xl"
                />
                <div class={`absolute bottom-4 right-4 w-6 h-6 rounded-full border-4 border-background ${isOnline ? 'bg-green-500' : 'bg-red-500'}`} title={isOnline ? "Online" : "Offline"}></div>
            </div>

            {/* Columna Derecha: Información y Estadísticas */}
            <div class="flex-1 w-full space-y-8">
                <div class="space-y-4">
                    <div class="space-y-2 text-center md:text-left">
                        <div class="inline-flex items-center rounded-md border border-border bg-muted px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 text-foreground capitalize">
                            {playerGroup}
                        </div>
                        <h1 class="text-4xl font-bold tracking-tight lg:text-5xl text-foreground">
                            {member}
                        </h1>
                    </div>

                    {/* Perfil Personal (Bio y Redes) */}
                    <PlayerProfile member={member} />
                </div>

                {/* Estadísticas */}
                <div class="space-y-6 pt-4 border-t border-border">
                    <div class="flex items-center gap-2 pb-2">
                        <User className="h-5 w-5 text-brand-green" />
                        <h2 class="text-2xl font-semibold tracking-tight text-foreground">Estadísticas</h2>
                    </div>
                    <PlayerStats member={member} />
                </div>
            </div>
        </div>
    </div>
</Layout>
